/*----------------------------------------------------------------
 * Author : Yuvraj Saxena (frap13000@github.com)
 * Contact : frap13000@gmail.com
 * Note : (Don't remove this block of code from here!)
 * Neither you and nor your any friends or family members will!
 * change credits from here! you know the consequences of removing!
 *---------------------------------------------------------------*/

#ifndef BUILD_LK
#include <linux/string.h>
#endif
#include "lcm_drv.h"

#ifdef BUILD_LK
	#include <platform/mt_gpio.h>
#elif defined(BUILD_UBOOT)
	#include <asm/arch/mt_gpio.h>
#else
	#include <mach/mt_gpio.h>
#endif

/* ---------------------------------------------------------------------------
   Local Constants
   --------------------------------------------------------------------------- */

#define FRAME_WIDTH  (720)
#define FRAME_HEIGHT (1280)

#ifndef TRUE
    #define TRUE 1
#endif

#ifndef FALSE
    #define FALSE 0
#endif

#define REGFLAG_DELAY                                       0XFC
#define REGFLAG_END_OF_TABLE                                0xFD


#define LCM_ID_NT35590 (0x90)

/* ---------------------------------------------------------------------------
   Local Variables
   --------------------------------------------------------------------------- */

static LCM_UTIL_FUNCS lcm_util = {0};

#define SET_RESET_PIN(v)    (lcm_util.set_reset_pin((v)))

#define UDELAY(n) (lcm_util.udelay(n))
#define MDELAY(n) (lcm_util.mdelay(n))

/* ---------------------------------------------------------------------------
   Local Functions
   --------------------------------------------------------------------------- */

#define dsi_set_cmdq_V2(cmd, count, ppara, force_update)	        lcm_util.dsi_set_cmdq_V2(cmd, count, ppara, force_update)
#define dsi_set_cmdq(pdata, queue_size, force_update)		lcm_util.dsi_set_cmdq(pdata, queue_size, force_update)
#define wrtie_cmd(cmd)										lcm_util.dsi_write_cmd(cmd)
#define write_regs(addr, pdata, byte_nums)					lcm_util.dsi_write_regs(addr, pdata, byte_nums)
#define read_reg(cmd)											lcm_util.dsi_dcs_read_lcm_reg(cmd)
#define read_reg_v2(cmd, buffer, buffer_size)   				lcm_util.dsi_dcs_read_lcm_reg_v2(cmd, buffer, buffer_size)   

static struct LCM_setting_table
{
    unsigned cmd;
    unsigned char count;
    unsigned char para_list[64];
};

static struct LCM_setting_table lcm_initialization_setting[] =
{
{0xf0, 5, {0x55,0xaa,0x52,0x08,0x00}},
{0xbd, 5, {0x01,0xa0,0x10,0x10,0x01}},
{0xb8, 4, {0x01,0x02,0x0c,0x02}},
{0xbb, 2, {0x11,0x11}},
{0xbc, 2, {0x00,0x00}},
{0xb6, 1, {0x04}},
{0xc8, 1, {0x80}},
{0xd9, 2, {0x01,0x01}},
{0xd4, 1, {0xc7}},
{0xb1, 2, {0x60,0x21}},
{0xf0, 5, {0x55,0xaa,0x52,0x08,0x01}},
{0xb0, 2, {0x09,0x09}},
{0xb1, 2, {0x09,0x09}},
{0xbc, 2, {0x90,0x00}},
{0xbd, 2, {0x90,0x00}},
{0xbe, 1, {0x3f}},
{0xca, 1, {0x00}},
{0xc0, 1, {0x0c}},
{0xb5, 2, {0x03,0x03}},
{0xb3, 2, {0x19,0x19}},
{0xb4, 2, {0x19,0x19}},
{0xb9, 2, {0x26,0x26}},
{0xba, 2, {0x24,0x24}},
{0xf0, 5, {0x55,0xaa,0x52,0x08,0x02}},
{0xee, 1, {0x01}},
{0xb0, 16, {0x00,0x0e,0x00,0x56,0x00,0x89,0x00,0xa9,0x00,0xc2,0x00,0xe7,0x01,0x05,0x01,0x34}},
{0xb1, 16, {0x01,0x5a,0x01,0x94,0x01,0xc1,0x02,0x07,0x02,0x3e,0x02,0x40,0x02,0x70,0x02,0xa5}},
{0xb2, 16, {0x02,0xc7,0x02,0xf4,0x03,0x13,0x03,0x3d,0x03,0x59,0x03,0x7f,0x03,0x99,0x03,0xb9}},
{0xb3, 4, {0x03,0xeb,0x03,0xfc}},
{0xb4, 16, {0x00,0x0e,0x00,0x56,0x00,0x89,0x00,0xa9,0x00,0xc2,0x00,0xe7,0x01,0x05,0x01,0x34}},
{0xb5, 16, {0x01,0x5a,0x01,0x94,0x01,0xc1,0x02,0x07,0x02,0x3e,0x02,0x40,0x02,0x70,0x02,0xa5}},
{0xb6, 16, {0x02,0xc7,0x02,0xf4,0x03,0x13,0x03,0x3d,0x03,0x59,0x03,0x7f,0x03,0x99,0x03,0xb9}},
{0xb7, 4, {0x03,0xeb,0x03,0xfc}},
{0xb8, 16, {0x00,0x0e,0x00,0x56,0x00,0x89,0x00,0xa9,0x00,0xc2,0x00,0xe7,0x01,0x05,0x01,0x34}},
{0xb9, 16, {0x01,0x5a,0x01,0x94,0x01,0xc1,0x02,0x07,0x02,0x3e,0x02,0x40,0x02,0x70,0x02,0xa5}},
{0xba, 16, {0x02,0xc7,0x02,0xf4,0x03,0x13,0x03,0x3d,0x03,0x59,0x03,0x7f,0x03,0x99,0x03,0xb9}},
{0xbb, 4, {0x03,0xeb,0x03,0xfc}},
{0xbc, 16, {0x00,0x0e,0x00,0x56,0x00,0x89,0x00,0xa9,0x00,0xc2,0x00,0xe7,0x01,0x05,0x01,0x34}},
{0xbd, 16, {0x01,0x5a,0x01,0x94,0x01,0xc1,0x02,0x07,0x02,0x3e,0x02,0x40,0x02,0x70,0x02,0xa5}},
{0xbe, 16, {0x02,0xc7,0x02,0xf4,0x03,0x13,0x03,0x3d,0x03,0x59,0x03,0x7f,0x03,0x99,0x03,0xb9}},
{0xbf, 4, {0x03,0xeb,0x03,0xfc}},
{0xc0, 16, {0x00,0x0e,0x00,0x56,0x00,0x89,0x00,0xa9,0x00,0xc2,0x00,0xe7,0x01,0x05,0x01,0x34}},
{0xc1, 16, {0x01,0x5a,0x01,0x94,0x01,0xc1,0x02,0x07,0x02,0x3e,0x02,0x40,0x02,0x70,0x02,0xa5}},
{0xc2, 16, {0x02,0xc7,0x02,0xf4,0x03,0x13,0x03,0x3d,0x03,0x59,0x03,0x7f,0x03,0x99,0x03,0xb9}},
{0xc3, 4, {0x03,0xeb,0x03,0xfc}},
{0xc4, 16, {0x00,0x0e,0x00,0x56,0x00,0x89,0x00,0xa9,0x00,0xc2,0x00,0xe7,0x01,0x05,0x01,0x34}},
{0xc5, 16, {0x01,0x5a,0x01,0x94,0x01,0xc1,0x02,0x07,0x02,0x3e,0x02,0x40,0x02,0x70,0x02,0xa5}},
{0xc6, 16, {0x02,0xc7,0x02,0xf4,0x03,0x13,0x03,0x3d,0x03,0x59,0x03,0x7f,0x03,0x99,0x03,0xb9}},
{0xc7, 4, {0x03,0xeb,0x03,0xfc}},
{0xf0, 5, {0x55,0xaa,0x52,0x08,0x06}},
{0xb0, 2, {0x31,0x2e}},
{0xb1, 2, {0x10,0x12}},
{0xb2, 2, {0x16,0x18}},
{0xb3, 2, {0x31,0x31}},
{0xb4, 2, {0x31,0x34}},
{0xb5, 2, {0x34,0x34}},
{0xb6, 2, {0x34,0x34}},
{0xb7, 2, {0x34,0x34}},
{0xb8, 2, {0x33,0x2d}},
{0xb9, 2, {0x00,0x02}},
{0xba, 2, {0x03,0x01}},
{0xbb, 2, {0x2d,0x33}},
{0xbc, 2, {0x34,0x34}},
{0xbd, 2, {0x34,0x34}},
{0xbe, 2, {0x34,0x34}},
{0xbf, 2, {0x34,0x31}},
{0xc0, 2, {0x31,0x31}},
{0xc1, 2, {0x19,0x17}},
{0xc2, 2, {0x13,0x11}},
{0xc3, 2, {0x2e,0x31}},
{0xe5, 2, {0x31,0x31}},
{0xc4, 2, {0x31,0x2d}},
{0xc5, 2, {0x19,0x17}},
{0xc6, 2, {0x13,0x11}},
{0xc7, 2, {0x31,0x31}},
{0xc8, 2, {0x31,0x34}},
{0xc9, 2, {0x34,0x34}},
{0xca, 2, {0x34,0x34}},
{0xcb, 2, {0x34,0x34}},
{0xcc, 2, {0x33,0x2e}},
{0xcd, 2, {0x03,0x01}},
{0xce, 2, {0x00,0x02}},
{0xcf, 2, {0x2e,0x33}},
{0xd0, 2, {0x34,0x34}},
{0xd1, 2, {0x34,0x34}},
{0xd2, 2, {0x34,0x34}},
{0xd3, 2, {0x34,0x31}},
{0xd4, 2, {0x31,0x31}},
{0xd5, 2, {0x10,0x12}},
{0xd6, 2, {0x16,0x18}},
{0xd7, 2, {0x2d,0x31}},
{0xe6, 2, {0x31,0x31}},
{0xd8, 5, {0x00,0x00,0x00,0x00,0x00}},
{0xd9, 5, {0x00,0x00,0x00,0x00,0x00}},
{0xe7, 1, {0x00}},
{0xf0, 5, {0x55,0xaa,0x52,0x08,0x05}},
{0xed, 1, {0x30}},
{0xb0, 2, {0x17,0x06}},
{0xb8, 1, {0x00}},
{0xc0, 1, {0x0d}},
{0xc1, 1, {0x0b}},
{0xc2, 1, {0x00}},
{0xc3, 1, {0x00}},
{0xc4, 1, {0x84}},
{0xc5, 1, {0x82}},
{0xc6, 1, {0x82}},
{0xc7, 1, {0x80}},
{0xc8, 1, {0x0b}},
{0xc9, 2, {0x07,0x20}},
{0xca, 2, {0x01,0x10}},
{0xd1, 5, {0x03,0x05,0x05,0x07,0x00}},
{0xd2, 5, {0x03,0x05,0x09,0x03,0x00}},
{0xd3, 5, {0x00,0x00,0x6a,0x07,0x10}},
{0xd4, 5, {0x30,0x00,0x6a,0x07,0x10}},
{0xf0, 5, {0x55,0xaa,0x52,0x08,0x03}},
{0xb0, 2, {0x00,0x00}},
{0xb1, 2, {0x00,0x00}},
{0xb2, 5, {0x05,0x01,0x13,0x00,0x00}},
{0xb3, 5, {0x05,0x01,0x13,0x00,0x00}},
{0xb4, 5, {0x05,0x01,0x13,0x00,0x00}},
{0xb5, 5, {0x05,0x01,0x13,0x00,0x00}},
{0xb6, 5, {0x02,0x01,0x13,0x00,0x00}},
{0xb7, 5, {0x02,0x01,0x13,0x00,0x00}},
{0xb8, 5, {0x02,0x01,0x13,0x00,0x00}},
{0xb9, 5, {0x02,0x01,0x13,0x00,0x00}},
{0xba, 5, {0x53,0x01,0x13,0x00,0x00}},
{0xbb, 5, {0x53,0x01,0x13,0x00,0x00}},
{0xbc, 5, {0x53,0x01,0x13,0x00,0x00}},
{0xbd, 5, {0x53,0x01,0x13,0x00,0x00}},
{0xc4, 1, {0x60}},
{0xc5, 1, {0x40}},
{0xc6, 1, {0x64}},
{0xc7, 1, {0x44}},
{0x6f, 1, {0x11}},
{0xf3, 1, {0x01}},
{0x35, 1, {0x00}},
{0x11, 1, {0x00}},
{REGFLAG_DELAY, 150, {}},
{0x29, 1, {0x00}},
{REGFLAG_DELAY, 50, {}},
{REGFLAG_END_OF_TABLE, 0x00, {}},
};

static void push_table(struct LCM_setting_table *table, unsigned int count, unsigned char force_update)
{
    unsigned int i;

    for(i = 0; i < count; i++)
    {

        unsigned cmd;
        cmd = table[i].cmd;

        switch (cmd)
        {

            case REGFLAG_DELAY :
                MDELAY(table[i].count);
                break;

            case REGFLAG_END_OF_TABLE :
                break;

            default:
				dsi_set_cmdq_V2(cmd, table[i].count, table[i].para_list, force_update);
        }
    }

}

/* ---------------------------------------------------------------------------
   LCM Driver Implementations
   --------------------------------------------------------------------------- */

static void lcm_set_util_funcs(const LCM_UTIL_FUNCS *util)
{
    memcpy(&lcm_util, util, sizeof(LCM_UTIL_FUNCS));
}

static void lcm_get_params(LCM_PARAMS *params)
{
	memset(params, 0, sizeof(LCM_PARAMS));

  params->dsi.LANE_NUM = 3;
  params->dsi.packet_size = 256;
  params->dsi.word_count = 2160;
  params->dsi.vertical_sync_active = 4;
  params->dsi.vertical_backporch = 38;
  params->dsi.vertical_frontporch = 40;
  params->dsi.lcm_esd_check_table[0].para_list[0] = 0x00;
  params->dsi.PLL_CLOCK = 239;
  params->width = 720;
  params->type = 2;
  params->dsi.data_format.format = 2;
  params->dsi.PS = 2;
  params->dsi.horizontal_active_pixel = 720;
  params->height = 1280;
  params->dsi.vertical_active_line = 1280;
  params->dbi.te_mode = 0;
  params->dsi.data_format.color_order = 0;
  params->dsi.data_format.trans_seq = 0;
  params->dsi.data_format.padding = 0;
  params->dsi.intermediat_buffer_num = 0;
  params->dsi.mode = 1;
  params->dsi.esd_check_enable = 1;
  params->dsi.customization_esd_check_enable = 1;
  params->dsi.lcm_esd_check_table[0].count = 1;
  params->dsi.ssc_disable = 1;
  params->dsi.compatibility_for_nvk = 1;
  params->dsi.horizontal_sync_active = 10;
  params->dsi.lcm_esd_check_table[0].cmd = 10;
  params->dsi.horizontal_backporch = 72;
  params->dsi.horizontal_frontporch = 72;
}

static unsigned int lcm_compare_id(void)
{
/*
	enable only when you're using two or more lcms in kernel and remove return 1;

	unsigned int id=0;
	unsigned char buffer[5];
	unsigned int array[16];

	SET_RESET_PIN(1);
	MDELAY(10); 	
	SET_RESET_PIN(0);
	MDELAY(50);
	SET_RESET_PIN(1);
	MDELAY(120);  

	array[0]=0x00063902;
	array[1]=0x52AA55F0;
	array[2]=0x00000108;
	dsi_set_cmdq(&array, 3, 1);
	
	array[0] = 0x00033700;
	dsi_set_cmdq(&array, 1, 1);
	read_reg_v2(0xc5, buffer, 3);
	
	printk("lcm_compare_id nt35521 buffer[0] = 0x%x,buffer[1] = 0x%x,buffer[2] = 0x%x\n",buffer[0],buffer[1],buffer[2]);

	if( (buffer[0]==0x55) && (buffer[1]==0x21) )
	{
		return 1;
	}
	else
	{
		return 0;
	}		
*/
	return 1;
}

static void lcm_init(void)
{
	SET_RESET_PIN(1);
	SET_RESET_PIN(0);
	MDELAY(50);
	SET_RESET_PIN(1);
	MDELAY(120);      
}

static void lcm_suspend(void)
{
	SET_RESET_PIN(1);
	SET_RESET_PIN(0);
	MDELAY(50);
	SET_RESET_PIN(1);
	MDELAY(120);
}

static void lcm_resume(void)
{
	lcm_init();
}

/* ---------------------------------------------------------------------------
   Get LCM Driver Hooks
   --------------------------------------------------------------------------- */

LCM_DRIVER nt35521_hd720_dsi_vdo_xingliangda_lcm_drv = 
{
        .name		= "nt35521_hd720_dsi_vdo_xingliangda",
	.set_util_funcs = lcm_set_util_funcs,
	.get_params     = lcm_get_params,
	.init           = lcm_init,
	.suspend        = lcm_suspend,
	.resume         = lcm_resume,
	.compare_id     = lcm_compare_id,
};
